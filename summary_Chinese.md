九坤投资：GoldRush 金币编程争夺赛赛后总结

队伍成员：
郭宁峰，中央财经大学
张一童，北京大学
李子灼，西南财经大学。

# 1. 赛题简要回顾

* **环境**：17×17 离散网格，1v1，对角出生。单元格状态五类：空/金币/障碍/炸弹/玩家。
* **动态**：

  * 中央 9×9 每回合掉金币；NPC 按周期 Z 出现、沿路径撒币后离场；炸弹按周期 Y 刷新。
  * 每回合每名玩家有**3 次**上下左右单步行动；越界/撞障碍/撞人当次动作忽略，其余继续。
  * **执行先后由决策延迟**决定，同格资源争夺先到先得；踏雷按持币 X% 扣减后雷消失。
* **目标**：300 回合后持币多者胜。
* **硬约束**：每回合接口时限 1s，越快越占优。

# 2. 本赛题解决方案

## 2.1 策略框架（决策流 + 关键公式）

---

策略概述：**冲突先解、全局稳进、远端只在净增益显著时改线**。优先级从确定性抢先到启发式搜索，再到仿真门控，避免了两种常见的低收益行为：为远处金币走冤枉路、为近处金币和对手互卡。

---

设：

* 当前回合为 $t$，地图 $G_t\in\mathbb{Z}^{17\times17}$；单元值定义同赛题。
* 我方位置 $s_t=(x_t,y_t)$，对手位置 $o_t$。
* 行动集 $\mathcal{A}=\{0,1,2,3\}$ 分别对应上/下/左/右，位移向量 $(DX[a],DY[a])$。
* 合法性判定 $V(p,a)=1$ 表示从位置 $p$ 执行动作 $a$ 合法，否则为 0。
* 炸弹集合 $\mathcal{B}_t$，金币集合 $\mathcal{C}_t=\{u\mid G_t(u)>0\}$，单元金币值 $v(u)=G_t(u)$。

总体决策流每回合一次，生成 3 步动作 $[a_1,a_2,a_3]$。流程按优先级串联：

## Step 0：尾盘短视最大化（硬规则）

若 $t\ge 295$，直接解 3 步内的**折扣收益极大化**：

$$
\max_{(a_1,a_2,a_3)\in \mathcal{A}^3}\quad R_{\text{3step}}(a_{1:3})
$$

其中

$$
R_{\text{3step}}(a_{1:3})=\sum_{i=1}^{3} \gamma^{\,i-1}\cdot \big[v(p_i)\cdot \rho(p_i)\big] - \sum_{i=1}^{3} \mathbf{1}[p_i\in \mathcal{B}_t]\cdot L_i
$$

* $p_i$ 为第 $i$ 步后我方位置；$\gamma\in(0,1)$ 为轻折扣（实装 $\gamma=0.95$）。
* $\rho(p)$ 为**区域乘子**（见 Step 3）；
* ⌈X%·gold_{i-1}⌉ 为第 $i$ 步踩雷损失（gold_{i-1} 为该步前持币）。
  取最优序列；若不可行动（全非法），走安全兜底（向中心贪心三步）。

## Step 1：图上距离与对手可达性（公共底座）

用 BFS 得到我方最短格步距 $d_p(u)$、对手步距 $d_o(u)$，屏蔽 $\{-1,-2,-3\}$ 三类格。
同时记录**第一步方向集合** $\mathcal{F}(u)\subseteq\mathcal{A}$：从 $s_t$ 到 $u$ 的任一最短路可行首步集合（可能多条等长路）。

## Step 2：冲突检测与局部最优抢占

定义**三步冲突集合**：

$$
\mathcal{Q}=\{u\in \mathcal{C}_t \mid d_p(u)\le 3 \ \land\ d_o(u)\le 3\}
$$

若 $\mathcal{Q}\neq\emptyset$，执行**三步局部枚举**，解：

$$
\max_{(a_1,a_2,a_3)\in \mathcal{A}^3}\quad R_{\text{3step}}(a_{1:3})
$$

目标同 Step 0，但仅评估 3 步内“能吃到的不同格金币总和”，且禁止同格重复计数。枚举时剪枝：

* 非法步移除；
* 同步模拟“对手先手三步”的贪婪一阶响应（用我方单步启发式近似，见 Step 4），避免盲冲被截胡。
  若最优值 $R_{\text{3step}}^\star>0$ 则直接采用对应 $[a_1,a_2,a_3]$；否则转 Step 3。

## Step 3：引力场单步评分（全局启发式导航）

对每个有金币单元 $u\in\mathcal{C}_t$，将其价值按等价首步数分摊至每个首步方向 $d\in \mathcal{F}(u)$。**单步方向打分**：

$$
S(d)=\sum_{u\in\mathcal{C}_t,\ d\in\mathcal{F}(u)}
\underbrace{\frac{v(u)}{|\mathcal{F}(u)|}}\_{\text{分摊价值}}
\cdot 
\underbrace{\frac{1}{d_p(u)^2+\epsilon}}\_{\text{近端偏好}}
\cdot 
\underbrace{W\big(\Delta(u)\big)}\_{\text{对手差距权}}
\cdot 
\underbrace{\rho(u)}\_{\text{区域乘子}}
$$

其中 $\Delta(u)=d_o(u)-d_p(u)$。对手差距权给出**理性不抢**与**有望抢赢**的边界：

$$
W(\Delta)=
\begin{cases}
0.3,& \Delta<-6 \ \text{或}\ (\Delta\le -3 \land d_o(u)\le 3) \\
0.7,& 0\le \Delta\le 3 \\
1.3\cdot 0.9^{\max(0,d_o(u))},& 3<\Delta\le 6 \\
1,& \text{otherwise}
\end{cases}
$$

**区域乘子** $\rho(u)$ 由**中心-外圈密度差**自适应：

$$
\rho(u)=
\begin{cases}
1+\alpha\cdot \max\big( D_{\text{ctr}}-D_{\text{out}},\,0\big), & u \in 9\times 9 \text{ 中心}\\
1, & \text{其他}
\end{cases}
$$

密度估计用滑动统计（上一回合到当前回合的净新增金币量除以可通行格数）：
D_ctr = (ΔGold_ctr) / (#cells_ctr),
D_out = (ΔGold_out) / (#cells_out),
α 为小正数 (例如 0.1)

单步选择：

$$
a^\star=\arg\max_{d\in\mathcal{A}} S(d)
$$

若平手，随机于并列方向，避免被策略性卡位读手。

将 $a^\star$ 应用于**滚动三步**：每走一步，更新当前位置与可拾金币（模拟置零），重复此单步评分，得到 $[a_1,a_2,a_3]$。

## Step 4：前瞻评估与净增益门控（只对高价值候选触发）

为了防止“远端看起来高收益，实际前往却被对手抢先获取”的脑热，对 Top-K 金币点位做**计划 vs 基线**对比。

1. 候选集 $\mathcal{U}_K\subset\mathcal{C}_t$：按 $v(u)$ 降序取前 K（实装 $K\le 100$）。
2. 对每个 $u\in\mathcal{U}_K$，找一条到达路径 $\pi(u)$ 最小化**阻力成本**：

$$
\min_{\pi:u_0=s_t\to u}\ C(\pi)=\sum_{e\in\pi} c(e),\qquad
c(e)=
\begin{cases}
2,& \text{空白格}\\
1/v(u')^2,& \text{金币格 }u'\\
+\infty,& \text{障碍/对手/炸弹}
\end{cases}
$$

3. 用**轮式对弈仿真**评估未来 $H$ 步（实装 $H=18$）的收益，记
Gain_plan(u)和Gain_base（基线为 Step 3 的滚动三步重复）。
仿真细节：每满 3 步算一轮，对手先走，用**单步引力启发式算法**近似对手行为；金币拾取即时清零；炸弹损失用真实规则；区域乘子同上。

4. **净增益门控**（只在显著胜基线时改线）：

$$
\Delta(u)=\big[\text{Gain}_{\text{plan}}(u)-\text{Gain}_{\text{base}}\big]
$$

如果 $\max_{u\in\mathcal{U}_K}\Delta(u)\ge \tau$（阈值实装 $\tau=5$），采用对应 $u^\star$ 的路径前 1–3 步；否则维持基线 $[a_1,a_2,a_3]$。


## Step 5：炸弹风险与阈值化规避

定义当前持币 $g$。设置炸弹规避阈值 $\theta_b$（实装常数或随 $t$ 增长）。

* 若 $g>\theta_b$，任何候选首步若将踏雷则拒绝该步。
* 若 $g\le \theta_b$，允许以小亏换位，但需满足**正净值条件**：

$E$[后续可得] - ⌈X% · g⌉ ≥ 0


其中“后续可得”用 Step 4 的短窗仿真近似；不满足则不踩。

## Step 6：异常与兜底

* 缺位信息（比如未发现我方位置）：走“向中心三步”的安全贪心。
* 若连续两次单步评分均无合法方向，选**就近安全方向** $a\in\mathcal{A}$ 使障碍/炸弹/对手三类回避优先级最大。

---

## 复杂度与时延控制（保证 1s 内返回）

* 一轮 BFS：$O(17^2)$；
* 3 步枚举：常数阶（最多 $4^3=64$ 条路径），带早停与非法剪枝；
* 候选 K 的前瞻仿真：K ≤ 100，H = 18 时在 C++ 下轻松 < 1s；遇到稀疏金币可自适应减 K。
* 数据结构：数组/`deque`，避免堆分配；更新网格用局部拷贝。

---

## 本节核心公式清单（速查）

1. 单步引力评分

$$
S(d)=\sum_{u}\frac{v(u)}{|\mathcal{F}(u)|}\cdot\frac{1}{d_p(u)^2+\epsilon}\cdot W\big(d_o(u)-d_p(u)\big)\cdot \rho(u)
$$

2. 区域乘子

$$
\rho(u)=
\begin{cases}
1+\alpha \cdot \max(D_{\text{ctr}}-D_{\text{out}},0), & u\in \text{中心}\\
1,& \text{其他}
\end{cases}
$$

3. 三步收益（局部/尾盘相同）

$$
R_{\text{3step}}=\sum_{i=1}^{3}\gamma^{i-1}\,v(p_i)\rho(p_i)-\sum_{i=1}^{3}\mathbf{1}[p_i\in\mathcal{B}_t]\cdot \lceil X\%\cdot \text{gold}_{i-1}\rceil
$$

4. 计划净增益门控

$$
\Delta(u)=\text{Gain}_{\text{plan}}(u)-\text{Gain}_{\text{base}},\quad \text{采用当且仅当 }\max_u \Delta(u)\ge \tau
$$

5. 踩雷正净值条件

$E$[后续可得] - ⌈X% · g⌉ ≥ 0



## 2.2 工程与时延优化

* **BFS 复用**：对手距离图一次生成，多处复用；我方到各格的第一步方向在一次 BFS 里回溯，避免多次最短路。
* **剪枝**：三步枚举中去重同格二次拾取；竞争检测先做 3 步可达集合交集，未交集不启用重算。
* **数据结构**：数组/双端队列替代重型容器；分支顺序按命中率排布。
* **异常兜底**：出现无位置信息或全阻塞，统一走“向中心三步”的安全策略，保证 1s 内稳定返回。

## 2.3 策略优劣与复盘

* **强项**：

  * 低延迟、稳定回包，吃到“先手执行”的隐藏收益。
  * 对**近端高值币**反应快，冲突区胜率高。
  * 尾盘明确，能把握最后一轮的确定性收益。
* **短板**：

  * 没有显式**对手建模**，对极端“堵门/诱雷”对手适应慢。
  * “中心偏好乘子”是启发式，可能对突变的网格环境反应滞后。
* **可能的改进方向**：

  * 引入**元策略选择器**：在“引力场/三步穷举/堵截路径搜索”间做多臂赌博或贝叶斯切换。
  * 轻量级对手画像（近三回合轨迹 + 贪婪/阻断倾向评分），动态调整 `w(·)`。


# 3. 与金融市场的联系、对量化研究的启发

把这题当成一个简化的“市场微观结构操场”，映射关系如下：

## 3.1 与金融市场的联系

* **金币** ≈ **可提取的流动性/alpha**：分布动态变化，中心区高产像热门交易时段或主战场品种的高成交密度区。
* **炸弹** ≈ **不利流动性与冲击成本**：例如跳空、隐藏撤单、交易税费或冲击成本，持仓越大损失越多（损失按持币比例）。
* **执行先后取决于决策延迟** ≈ **撮合优先级/低延迟交易**：更快的决策与通信意味着更高的成交概率与更低的排队风险。
* **障碍与对手** ≈ **市场约束与对手策略**：价格限制、风控边界、以及其他策略的空间阻断。
* **NPC 定期撒币** ≈ **周期性的外生大宗订单流**：周期性事件驱动的流动性注入，对路径决策提出再优化需求。

## 3.2 对量化研究的具体启发

**1. “信号”不等于“收益”**

   * 靠近高价值金币的“信号”必须扣除**到达时间、被截胡概率、路上炸弹成本**。这等价于现实里要用**可实现 alpha**，把冲击成本、队列位置、成交概率全部进模型。
   * 形式化：

**Expected PnL** = Σᵢ [ αᵢ (信号) · Pr(fillᵢ) ] − C_impact (冲击) − C_fee (费用)

     我在方案里用 `w(o_dist-p_dist)`、`1/p_dist^2`、以及炸弹阈值，正是这些现实折扣的网格版本。

**2. 延迟是隐形的阿尔法税**

   * 本赛制把“先执行”写进规则，这和真实交易里**撮合延迟、排队时间**一模一样。
   * 在日内高频因子开发中必须考虑（1）**对手方行为**，例如用对手方盘口深度或档位变动速度刻画对手方行为）。（2）**实现时间**，做策略不仅要“算得准”，还要“**算得快**”。延迟每减少 1ms，成交概率和滑点期望都在变，计算优化不是锦上添花，是整个策略收益的一部分。
   * 在回测系统中考虑**成交概率、队列位置估计**与**冲击成本曲线**，更关注“实现 PnL”而不是“信号收益”。

**3. 风险预算与位置管理**

   * 可以把炸弹损失看作**乘数风险**，持币越多越怕炸弹，这类似于**库存风险**。现实里库存高时应降低冲击风险、缩小报价或提高避险比重。
   * 对高风险时段引入**阈值化仓位管理**：如本题的炸弹阈值，在实盘里对应波动骤升时的降权或停单。

---

**结论**：本题目的本质是把“可兑现的超额收益”在**延迟、拥挤、冲击**中抢出来。策略要同时考虑：信号质量、执行优先级、风险成本。


